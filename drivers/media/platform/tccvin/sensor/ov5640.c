/*
 * ov5640.c 
 *
 * Author:  <linux@telechips.com>
 * Created: 2013 
 * Description: This is OV5640 image sensor driver.
 *
 * Copyright (c) Telechips, Inc.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 *
 */
#include <linux/kernel.h>
#include <linux/module.h>
#include <linux/delay.h>
#include <asm/system.h>
#include <asm/io.h>
#include <asm/mach-types.h>
#include <linux/slab.h>
#include <linux/i2c.h>
#include <linux/videodev2.h>		// standard ioctl
#include <mach/tcc_cam_ioctrl.h>	// user spec ioctl
#include <mach/vioc_vin.h>

#include "tcc_vin_hw.h"


#ifdef CONFIG_TCC_SENSOR_DEBUG
#define DBG_I2C_READ
#define dprintk(msg...)	printk(msg)
#else
#define dprintk(msg...)
#endif

#define OV5640_1080P_30FPS
//#define OV5640_1080P_24FPS
//#define OV5640_1080P_15FPS
//#define OV5640_SVGA_15FPS
//#define OV5640_720P_30FPS

#define OV5640_GAMMA_CANNON
//#define OV5640_GAMMA_STRONG

#define I2C_FLAG	0xFF

struct reg_fmt {
	unsigned short reg;		/* 16-bit register */
	unsigned char val;		/* 8-bit value */
};

/* Array of image sizes supported by ov5640.  These must be ordered from 
 * smallest image size to largest.
 */
static struct capture_size sensor_sizes[] = {
	{ 1920, 1080 },	/* 1080p */
	{ 1280,  720 },	/* 720p */
	{  800,  600 },	/* SVGA */
};

extern int cif_i2c_send(struct i2c_client *client, unsigned char* data, unsigned short reg_bytes, unsigned short data_bytes);
extern int cif_i2c_recv(struct i2c_client *client, unsigned short reg, unsigned char reg_bytes, unsigned char *val, unsigned short val_bytes);	
extern int vincore_set_zoom(struct tcc_video_device *vdev, int arg);
extern int vincore_set_frameskip(struct tcc_video_device *vdev, int arg);

static struct v4l2_ctrl_t _v4l2_ctrl[] = {
	{
		{
			.id = V4L2_CID_FRAMESKIP,
			.type = V4L2_CTRL_TYPE_INTEGER,
			.name = "Frame Skip",
			.minimum = 0,
			.maximum = 15,
			.step = 1,
			.default_value = 0,	// not skip
			.flags = 0,
		},
		.current_value = 0,
		.need_set = 0,
	},
};

static unsigned int _v4l2_re_ctrl[] = {
	V4L2_CID_FRAMESKIP,
};


/* register initialization tables for sensor */
/* common sensor register initialization for all image sizes, pixel formats, 
 * and frame rates
 */
#if defined(OV5640_1080P_30FPS)
static struct reg_fmt sensor_initialize[] = {
	/* 1920x1080p Full-HD 30fps
	 */
	{0x3103,0x11},
	{0x3008,0x82},
	{0x3008,0x42},
	{0x3103,0x03},

	//{0x3017,0xff},	// FREX,VSYNC,HREF,PCLK,D[9:6] is output
	{0x3017,0x7f},	// FREX is input. VSYNC,HREF,PCLK,D[9:6] is output

	{0x3018,0xff},

	//{0x302c,0xc2},	// output drive capability 4x
	{0x302c,0x02},	//  output drive capability 1x

	{0x3031,0x08},	//TODO: use? or not?  // bit[3]=1 for disable internal regulator

	{0x3034,0x1a},

	/* 15fps 84Mhz */
	//{0x3035,0x21}, //0x21 15fps;0x11 30fps some backend chip can not support higher fps(as 30fps)
	//{0x3036,0x69},
	/* 30fps 160Mhz */
	{0x3035,0x11},
	{0x3036,0x69},
	/* 24fps 134Mhz */
	//{0x3035,0x11},
	//{0x3036,0x54},

	{0x3037,0x13},
	{0x3108,0x01},
	{0x3630,0x36},
	{0x3631,0x0e},
	{0x3632,0xe2},
	{0x3633,0x12},
	{0x3621,0xe0},
	{0x3704,0xa0},
	{0x3703,0x5a},
	{0x3715,0x78},
	{0x3717,0x01},
	{0x370b,0x60},
	{0x3705,0x1a},
	{0x3905,0x02},
	{0x3906,0x10},
	{0x3901,0x0a},
	{0x3731,0x12},
	{0x3600,0x08},
	{0x3601,0x33},
	{0x302d,0x60},
	{0x3620,0x52},
	{0x371b,0x20},
	{0x471c,0x50},
	{0x3a13,0x43},
	{0x3a18,0x00},
	{0x3a19,0xf8},
	{0x3635,0x13},
	{0x3636,0x03},
	{0x3634,0x40},
	{0x3622,0x01},
	{0x3c01,0x34},
	{0x3c04,0x28},
	{0x3c05,0x98},
	{0x3c06,0x00},
	{0x3c07,0x07},
	{0x3c08,0x00},
	{0x3c09,0x1c},
	{0x3c0a,0x9c},
	{0x3c0b,0x40},
	{0x3820,0x40},
	{0x3821,0x06},
	{0x3814,0x11},
	{0x3815,0x11},
	{0x3800,0x01},
	{0x3801,0x50},
	{0x3802,0x01},
	{0x3803,0xb2},
	{0x3804,0x08},
	{0x3805,0xef},
	{0x3806,0x05},
	{0x3807,0xf1},
	{0x3808,0x07},
	{0x3809,0x80},
	{0x380a,0x04},
	{0x380b,0x38},
	{0x380c,0x09},
	{0x380d,0xc4},
	{0x380e,0x04},
	{0x380f,0x60},
	{0x3810,0x00},
	{0x3811,0x10},
	{0x3812,0x00},
	{0x3813,0x04},
	{0x3618,0x04},
	{0x3612,0x2b},
	{0x3708,0x64},
	{0x3709,0x12},
	{0x370c,0x00},
	{0x3a02,0x04},
	{0x3a03,0x60},
	{0x3a08,0x01},
	{0x3a09,0x50},
	{0x3a0a,0x01},
	{0x3a0b,0x18},
	{0x3a0e,0x03},
	{0x3a0d,0x04},
	{0x3a14,0x04},
	{0x3a15,0x60},
	{0x4001,0x02},
	{0x4004,0x06},
	{0x3000,0x00},
	{0x3002,0x1c},
	{0x3004,0xff},
	{0x3006,0xc3},
	{0x300e,0x58},
	{0x302e,0x00},

	//{0x4300,0x30},	// YUV422 YUYV
	{0x4300,0x32},	// YUV422 UYVY

	{0x501f,0x00},
	{0x4713,0x02},
	{0x4407,0x04},
	{0x440e,0x00},
	{0x460b,0x37},

	//{0x4740,0x20},
	{0x4740,0x00},	// pclk ative low

	{0x460c,0x20},
	{0x4837,0x16},
	{0x3824,0x04},
	{0x5000,0xa7},
	{0x5001,0x83},
	{0x5180,0xff},
	{0x5181,0xf2},
	{0x5182,0x00},
	{0x5183,0x14},
	{0x5184,0x25},
	{0x5185,0x24},
	{0x5186,0x09},
	{0x5187,0x09},
	{0x5188,0x09},
	{0x5189,0x75},
	{0x518a,0x54},
	{0x518b,0xe0},
	{0x518c,0xb2},
	{0x518d,0x42},
	{0x518e,0x3d},
	{0x518f,0x56},
	{0x5190,0x46},
	{0x5191,0xf8},
	{0x5192,0x04},
	{0x5193,0x70},
	{0x5194,0xf0},
	{0x5195,0xf0},
	{0x5196,0x03},
	{0x5197,0x01},
	{0x5198,0x04},
	{0x5199,0x12},
	{0x519a,0x04},
	{0x519b,0x00},
	{0x519c,0x06},
	{0x519d,0x82},
	{0x519e,0x38},

	{0x5300,0x08},
	{0x5301,0x30},

	//{0x5302,0x10},
	{0x5302,0x00}, //for improve noise

	{0x5303,0x00},
	{0x5304,0x08},
	{0x5305,0x30},
	{0x5306,0x08},
	{0x5307,0x16},
	{0x5309,0x08},
	{0x530a,0x30},
	{0x530b,0x04},
	{0x530c,0x06},
	{0x5480,0x01},

	#if defined(OV5640_GAMMA_CANNON)
	/* 1.canon gamma saturation 120 setting.bmp by below setting added */
	{0x5481,0x06},	// Cannon_Gamma
	{0x5482,0x0c},
	{0x5483,0x1a},
	{0x5484,0x46},
	{0x5485,0x5e},
	{0x5486,0x74},
	{0x5487,0x86},
	{0x5488,0x95},
	{0x5489,0xa1},
	{0x548a,0xab},
	{0x548b,0xbc},
	{0x548c,0xc9},
	{0x548d,0xdd},
	{0x548e,0xec},
	{0x548f,0xf5},
	{0x5490,0x0e},

	{0x5381,0x32},	// Matrix1_Sat120
	{0x5382,0x3d},
	{0x5383,0x11},
	{0x5384,0x10},
	{0x5385,0x6c},
	{0x5386,0x7c},
	{0x5387,0x7a},
	{0x5388,0x6c},
	{0x5389,0x0e},
	{0x538b,0x98},
	{0x538a,0x01},
	#elif defined(OV5640_GAMMA_STRONG)
	/* 2.strong contrast gamma saturation120 setting.bmp by below setting added */
	{0x5481,0x02},	// StrongContrast_Gamma
	{0x5482,0x04},
	{0x5483,0x0f},
	{0x5484,0x41},
	{0x5485,0x5c},
	{0x5486,0x73},
	{0x5487,0x87},
	{0x5488,0x98},
	{0x5489,0xa7},
	{0x548a,0xb4},
	{0x548b,0xcb},
	{0x548c,0xdd},
	{0x548d,0xf0},
	{0x548e,0xf9},
	{0x548f,0xfd},
	{0x5490,0x04},

	{0x5381,0x27},	// Matrix1_Sat120
	{0x5382,0x42},
	{0x5383,0x18},
	{0x5384,0x0e},
	{0x5385,0x61},
	{0x5386,0x6f},
	{0x5387,0x6c},
	{0x5388,0x5c},
	{0x5389,0x10},
	{0x538b,0x98},
	{0x538a,0x01},
	#else
	/* 3. default gamma */
	{0x5481,0x08},
	{0x5482,0x14},
	{0x5483,0x28},
	{0x5484,0x51},
	{0x5485,0x65},
	{0x5486,0x71},
	{0x5487,0x7d},
	{0x5488,0x87},
	{0x5489,0x91},
	{0x548a,0x9a},
	{0x548b,0xaa},
	{0x548c,0xb8},
	{0x548d,0xcd},
	{0x548e,0xdd},
	{0x548f,0xea},
	{0x5490,0x1d},

	{0x5381,0x1e},
	{0x5382,0x5b},
	{0x5383,0x08},
	{0x5384,0x0a},
	{0x5385,0x7e},
	{0x5386,0x88},
	{0x5387,0x7c},
	{0x5388,0x6c},
	{0x5389,0x10},
	{0x538a,0x01},
	{0x538b,0x98},
	#endif

	{0x5580,0x02},
	{0x5583,0x40},
	{0x5584,0x10},
	{0x5589,0x10},
	{0x558a,0x00},
	{0x558b,0xf8},
	{0x5800,0x23},
	{0x5801,0x14},
	{0x5802,0x0f},
	{0x5803,0x0f},
	{0x5804,0x12},
	{0x5805,0x26},
	{0x5806,0x0c},
	{0x5807,0x08},
	{0x5808,0x05},
	{0x5809,0x05},
	{0x580a,0x08},
	{0x580b,0x0d},
	{0x580c,0x08},
	{0x580d,0x03},
	{0x580e,0x00},
	{0x580f,0x00},
	{0x5810,0x03},
	{0x5811,0x09},
	{0x5812,0x07},
	{0x5813,0x03},
	{0x5814,0x00},
	{0x5815,0x01},
	{0x5816,0x03},
	{0x5817,0x08},
	{0x5818,0x0d},
	{0x5819,0x08},
	{0x581a,0x05},
	{0x581b,0x06},
	{0x581c,0x08},
	{0x581d,0x0e},
	{0x581e,0x29},
	{0x581f,0x17},
	{0x5820,0x11},
	{0x5821,0x11},
	{0x5822,0x15},
	{0x5823,0x28},
	{0x5824,0x46},
	{0x5825,0x26},
	{0x5826,0x08},
	{0x5827,0x26},
	{0x5828,0x64},
	{0x5829,0x26},
	{0x582a,0x24},
	{0x582b,0x22},
	{0x582c,0x24},
	{0x582d,0x24},
	{0x582e,0x06},
	{0x582f,0x22},
	{0x5830,0x40},
	{0x5831,0x42},
	{0x5832,0x24},
	{0x5833,0x26},
	{0x5834,0x24},
	{0x5835,0x22},
	{0x5836,0x22},
	{0x5837,0x26},
	{0x5838,0x44},
	{0x5839,0x24},
	{0x583a,0x26},
	{0x583b,0x28},
	{0x583c,0x42},
	{0x583d,0xce},
	{0x5025,0x00},
	{0x3a0f,0x30},
	{0x3a10,0x28},
	{0x3a1b,0x30},
	{0x3a1e,0x26},
	{0x3a11,0x60},
	{0x3a1f,0x14},
	{0x3008,0x02},
	{I2C_FLAG, I2C_FLAG}
};
#elif defined(OV5640_1080P_24FPS)
static struct reg_fmt sensor_initialize[] = {
	/* 1920x1080p Full-HD 24fps
	 */
	/* 1920x1080p Full-HD 30fps
	 */
	{0x3103,0x11},
	{0x3008,0x82},
	{0x3008,0x42},
	{0x3103,0x03},
	{0x3017,0xff},
	{0x3018,0xff},

	{0x302c,0xe7},	// add for max strength
	
	{0x3034,0x1a},

	/* 15fps 84Mhz */
	//{0x3035,0x21}, //0x21 15fps;0x11 30fps some backend chip can not support higher fps(as 30fps)
	//{0x3036,0x69},
	/* 30fps 160Mhz */
	//{0x3035,0x11},
	//{0x3036,0x69},
	/* 24fps 134Mhz */
	{0x3035,0x11},
	{0x3036,0x54},

	{0x3037,0x13},
	{0x3108,0x01},
	{0x3630,0x36},
	{0x3631,0x0e},
	{0x3632,0xe2},
	{0x3633,0x12},
	{0x3621,0xe0},
	{0x3704,0xa0},
	{0x3703,0x5a},
	{0x3715,0x78},
	{0x3717,0x01},
	{0x370b,0x60},
	{0x3705,0x1a},
	{0x3905,0x02},
	{0x3906,0x10},
	{0x3901,0x0a},
	{0x3731,0x12},
	{0x3600,0x08},
	{0x3601,0x33},
	{0x302d,0x60},
	{0x3620,0x52},
	{0x371b,0x20},
	{0x471c,0x50},
	{0x3a13,0x43},
	{0x3a18,0x00},
	{0x3a19,0xf8},
	{0x3635,0x13},
	{0x3636,0x03},
	{0x3634,0x40},
	{0x3622,0x01},
	{0x3c01,0x34},
	{0x3c04,0x28},
	{0x3c05,0x98},
	{0x3c06,0x00},
	{0x3c07,0x07},
	{0x3c08,0x00},
	{0x3c09,0x1c},
	{0x3c0a,0x9c},
	{0x3c0b,0x40},
	{0x3820,0x40},
	{0x3821,0x06},
	{0x3814,0x11},
	{0x3815,0x11},
	{0x3800,0x01},
	{0x3801,0x50},
	{0x3802,0x01},
	{0x3803,0xb2},
	{0x3804,0x08},
	{0x3805,0xef},
	{0x3806,0x05},
	{0x3807,0xf1},
	{0x3808,0x07},
	{0x3809,0x80},
	{0x380a,0x04},
	{0x380b,0x38},
	{0x380c,0x09},
	{0x380d,0xc4},
	{0x380e,0x04},
	{0x380f,0x60},
	{0x3810,0x00},
	{0x3811,0x10},
	{0x3812,0x00},
	{0x3813,0x04},
	{0x3618,0x04},
	{0x3612,0x2b},
	{0x3708,0x64},
	{0x3709,0x12},
	{0x370c,0x00},
	{0x3a02,0x04},
	{0x3a03,0x60},
	{0x3a08,0x01},
	{0x3a09,0x50},
	{0x3a0a,0x01},
	{0x3a0b,0x18},
	{0x3a0e,0x03},
	{0x3a0d,0x04},
	{0x3a14,0x04},
	{0x3a15,0x60},
	{0x4001,0x02},
	{0x4004,0x06},
	{0x3000,0x00},
	{0x3002,0x1c},
	{0x3004,0xff},
	{0x3006,0xc3},
	{0x300e,0x58},
	{0x302e,0x00},

	//{0x4300,0x30},	// YUV422 YUYV
	{0x4300,0x32},	// YUV422 UYVY

	{0x501f,0x00},
	{0x4713,0x02},
	{0x4407,0x04},
	{0x440e,0x00},
	{0x460b,0x37},

	//{0x4740,0x20},
	{0x4740,0x00},	// pclk ative low

	{0x460c,0x20},
	{0x4837,0x16},
	{0x3824,0x04},
	{0x5000,0xa7},
	{0x5001,0x83},
	{0x5180,0xff},
	{0x5181,0xf2},
	{0x5182,0x00},
	{0x5183,0x14},
	{0x5184,0x25},
	{0x5185,0x24},
	{0x5186,0x09},
	{0x5187,0x09},
	{0x5188,0x09},
	{0x5189,0x75},
	{0x518a,0x54},
	{0x518b,0xe0},
	{0x518c,0xb2},
	{0x518d,0x42},
	{0x518e,0x3d},
	{0x518f,0x56},
	{0x5190,0x46},
	{0x5191,0xf8},
	{0x5192,0x04},
	{0x5193,0x70},
	{0x5194,0xf0},
	{0x5195,0xf0},
	{0x5196,0x03},
	{0x5197,0x01},
	{0x5198,0x04},
	{0x5199,0x12},
	{0x519a,0x04},
	{0x519b,0x00},
	{0x519c,0x06},
	{0x519d,0x82},
	{0x519e,0x38},
	{0x5381,0x1e},
	{0x5382,0x5b},
	{0x5383,0x08},
	{0x5384,0x0a},
	{0x5385,0x7e},
	{0x5386,0x88},
	{0x5387,0x7c},
	{0x5388,0x6c},
	{0x5389,0x10},
	{0x538a,0x01},
	{0x538b,0x98},
	{0x5300,0x08},
	{0x5301,0x30},

	//{0x5302,0x10},
	{0x5302,0x00}, //for improve noise

	{0x5303,0x00},
	{0x5304,0x08},
	{0x5305,0x30},
	{0x5306,0x08},
	{0x5307,0x16},
	{0x5309,0x08},
	{0x530a,0x30},
	{0x530b,0x04},
	{0x530c,0x06},
	{0x5480,0x01},
	{0x5481,0x08},
	{0x5482,0x14},
	{0x5483,0x28},
	{0x5484,0x51},
	{0x5485,0x65},
	{0x5486,0x71},
	{0x5487,0x7d},
	{0x5488,0x87},
	{0x5489,0x91},
	{0x548a,0x9a},
	{0x548b,0xaa},
	{0x548c,0xb8},
	{0x548d,0xcd},
	{0x548e,0xdd},
	{0x548f,0xea},
	{0x5490,0x1d},
	{0x5580,0x02},
	{0x5583,0x40},
	{0x5584,0x10},
	{0x5589,0x10},
	{0x558a,0x00},
	{0x558b,0xf8},
	{0x5800,0x23},
	{0x5801,0x14},
	{0x5802,0x0f},
	{0x5803,0x0f},
	{0x5804,0x12},
	{0x5805,0x26},
	{0x5806,0x0c},
	{0x5807,0x08},
	{0x5808,0x05},
	{0x5809,0x05},
	{0x580a,0x08},
	{0x580b,0x0d},
	{0x580c,0x08},
	{0x580d,0x03},
	{0x580e,0x00},
	{0x580f,0x00},
	{0x5810,0x03},
	{0x5811,0x09},
	{0x5812,0x07},
	{0x5813,0x03},
	{0x5814,0x00},
	{0x5815,0x01},
	{0x5816,0x03},
	{0x5817,0x08},
	{0x5818,0x0d},
	{0x5819,0x08},
	{0x581a,0x05},
	{0x581b,0x06},
	{0x581c,0x08},
	{0x581d,0x0e},
	{0x581e,0x29},
	{0x581f,0x17},
	{0x5820,0x11},
	{0x5821,0x11},
	{0x5822,0x15},
	{0x5823,0x28},
	{0x5824,0x46},
	{0x5825,0x26},
	{0x5826,0x08},
	{0x5827,0x26},
	{0x5828,0x64},
	{0x5829,0x26},
	{0x582a,0x24},
	{0x582b,0x22},
	{0x582c,0x24},
	{0x582d,0x24},
	{0x582e,0x06},
	{0x582f,0x22},
	{0x5830,0x40},
	{0x5831,0x42},
	{0x5832,0x24},
	{0x5833,0x26},
	{0x5834,0x24},
	{0x5835,0x22},
	{0x5836,0x22},
	{0x5837,0x26},
	{0x5838,0x44},
	{0x5839,0x24},
	{0x583a,0x26},
	{0x583b,0x28},
	{0x583c,0x42},
	{0x583d,0xce},
	{0x5025,0x00},
	{0x3a0f,0x30},
	{0x3a10,0x28},
	{0x3a1b,0x30},
	{0x3a1e,0x26},
	{0x3a11,0x60},
	{0x3a1f,0x14},
	{0x3008,0x02},
	{I2C_FLAG, I2C_FLAG}
};
#elif defined(OV5640_1080P_15FPS)
static struct reg_fmt sensor_initialize[] = {
	/* 1920x1080p Full-HD 15fps
	 */
	{0x3103,0x11},
	{0x3008,0x82},
	{0x3008,0x42},
	{0x3103,0x03},
	{0x3017,0xff},
	{0x3018,0xff},

	{0x302c,0xe7},	// add for max strength
	
	{0x3034,0x1a},

	/* 15fps 84Mhz */
	{0x3035,0x21}, //0x21 15fps;0x11 30fps some backend chip can not support higher fps(as 30fps)
	{0x3036,0x69},
	/* 30fps 160Mhz */
	//{0x3035,0x11},
	//{0x3036,0x69},
	/* 24fps 134Mhz */
	//{0x3035,0x11},
	//{0x3036,0x54},

	{0x3037,0x13},
	{0x3108,0x01},
	{0x3630,0x36},
	{0x3631,0x0e},
	{0x3632,0xe2},
	{0x3633,0x12},
	{0x3621,0xe0},
	{0x3704,0xa0},
	{0x3703,0x5a},
	{0x3715,0x78},
	{0x3717,0x01},
	{0x370b,0x60},
	{0x3705,0x1a},
	{0x3905,0x02},
	{0x3906,0x10},
	{0x3901,0x0a},
	{0x3731,0x12},
	{0x3600,0x08},
	{0x3601,0x33},
	{0x302d,0x60},
	{0x3620,0x52},
	{0x371b,0x20},
	{0x471c,0x50},
	{0x3a13,0x43},
	{0x3a18,0x00},
	{0x3a19,0xf8},
	{0x3635,0x13},
	{0x3636,0x03},
	{0x3634,0x40},
	{0x3622,0x01},
	{0x3c01,0x34},
	{0x3c04,0x28},
	{0x3c05,0x98},
	{0x3c06,0x00},
	{0x3c07,0x07},
	{0x3c08,0x00},
	{0x3c09,0x1c},
	{0x3c0a,0x9c},
	{0x3c0b,0x40},
	{0x3820,0x40},
	{0x3821,0x06},
	{0x3814,0x11},
	{0x3815,0x11},
	{0x3800,0x01},
	{0x3801,0x50},
	{0x3802,0x01},
	{0x3803,0xb2},
	{0x3804,0x08},
	{0x3805,0xef},
	{0x3806,0x05},
	{0x3807,0xf1},
	{0x3808,0x07},
	{0x3809,0x80},
	{0x380a,0x04},
	{0x380b,0x38},
	{0x380c,0x09},
	{0x380d,0xc4},
	{0x380e,0x04},
	{0x380f,0x60},
	{0x3810,0x00},
	{0x3811,0x10},
	{0x3812,0x00},
	{0x3813,0x04},
	{0x3618,0x04},
	{0x3612,0x2b},
	{0x3708,0x64},
	{0x3709,0x12},
	{0x370c,0x00},
	{0x3a02,0x04},
	{0x3a03,0x60},
	{0x3a08,0x01},
	{0x3a09,0x50},
	{0x3a0a,0x01},
	{0x3a0b,0x18},
	{0x3a0e,0x03},
	{0x3a0d,0x04},
	{0x3a14,0x04},
	{0x3a15,0x60},
	{0x4001,0x02},
	{0x4004,0x06},
	{0x3000,0x00},
	{0x3002,0x1c},
	{0x3004,0xff},
	{0x3006,0xc3},
	{0x300e,0x58},
	{0x302e,0x00},

	//{0x4300,0x30},	// YUV422 YUYV
	{0x4300,0x32},	// YUV422 UYVY

	{0x501f,0x00},
	{0x4713,0x02},
	{0x4407,0x04},
	{0x440e,0x00},
	{0x460b,0x37},

	//{0x4740,0x20},
	{0x4740,0x00},	// pclk ative low

	{0x460c,0x20},
	{0x4837,0x16},
	{0x3824,0x04},
	{0x5000,0xa7},
	{0x5001,0x83},
	{0x5180,0xff},
	{0x5181,0xf2},
	{0x5182,0x00},
	{0x5183,0x14},
	{0x5184,0x25},
	{0x5185,0x24},
	{0x5186,0x09},
	{0x5187,0x09},
	{0x5188,0x09},
	{0x5189,0x75},
	{0x518a,0x54},
	{0x518b,0xe0},
	{0x518c,0xb2},
	{0x518d,0x42},
	{0x518e,0x3d},
	{0x518f,0x56},
	{0x5190,0x46},
	{0x5191,0xf8},
	{0x5192,0x04},
	{0x5193,0x70},
	{0x5194,0xf0},
	{0x5195,0xf0},
	{0x5196,0x03},
	{0x5197,0x01},
	{0x5198,0x04},
	{0x5199,0x12},
	{0x519a,0x04},
	{0x519b,0x00},
	{0x519c,0x06},
	{0x519d,0x82},
	{0x519e,0x38},
	{0x5381,0x1e},
	{0x5382,0x5b},
	{0x5383,0x08},
	{0x5384,0x0a},
	{0x5385,0x7e},
	{0x5386,0x88},
	{0x5387,0x7c},
	{0x5388,0x6c},
	{0x5389,0x10},
	{0x538a,0x01},
	{0x538b,0x98},
	{0x5300,0x08},
	{0x5301,0x30},

	//{0x5302,0x10},
	{0x5302,0x00}, //for improve noise

	{0x5303,0x00},
	{0x5304,0x08},
	{0x5305,0x30},
	{0x5306,0x08},
	{0x5307,0x16},
	{0x5309,0x08},
	{0x530a,0x30},
	{0x530b,0x04},
	{0x530c,0x06},
	{0x5480,0x01},
	{0x5481,0x08},
	{0x5482,0x14},
	{0x5483,0x28},
	{0x5484,0x51},
	{0x5485,0x65},
	{0x5486,0x71},
	{0x5487,0x7d},
	{0x5488,0x87},
	{0x5489,0x91},
	{0x548a,0x9a},
	{0x548b,0xaa},
	{0x548c,0xb8},
	{0x548d,0xcd},
	{0x548e,0xdd},
	{0x548f,0xea},
	{0x5490,0x1d},
	{0x5580,0x02},
	{0x5583,0x40},
	{0x5584,0x10},
	{0x5589,0x10},
	{0x558a,0x00},
	{0x558b,0xf8},
	{0x5800,0x23},
	{0x5801,0x14},
	{0x5802,0x0f},
	{0x5803,0x0f},
	{0x5804,0x12},
	{0x5805,0x26},
	{0x5806,0x0c},
	{0x5807,0x08},
	{0x5808,0x05},
	{0x5809,0x05},
	{0x580a,0x08},
	{0x580b,0x0d},
	{0x580c,0x08},
	{0x580d,0x03},
	{0x580e,0x00},
	{0x580f,0x00},
	{0x5810,0x03},
	{0x5811,0x09},
	{0x5812,0x07},
	{0x5813,0x03},
	{0x5814,0x00},
	{0x5815,0x01},
	{0x5816,0x03},
	{0x5817,0x08},
	{0x5818,0x0d},
	{0x5819,0x08},
	{0x581a,0x05},
	{0x581b,0x06},
	{0x581c,0x08},
	{0x581d,0x0e},
	{0x581e,0x29},
	{0x581f,0x17},
	{0x5820,0x11},
	{0x5821,0x11},
	{0x5822,0x15},
	{0x5823,0x28},
	{0x5824,0x46},
	{0x5825,0x26},
	{0x5826,0x08},
	{0x5827,0x26},
	{0x5828,0x64},
	{0x5829,0x26},
	{0x582a,0x24},
	{0x582b,0x22},
	{0x582c,0x24},
	{0x582d,0x24},
	{0x582e,0x06},
	{0x582f,0x22},
	{0x5830,0x40},
	{0x5831,0x42},
	{0x5832,0x24},
	{0x5833,0x26},
	{0x5834,0x24},
	{0x5835,0x22},
	{0x5836,0x22},
	{0x5837,0x26},
	{0x5838,0x44},
	{0x5839,0x24},
	{0x583a,0x26},
	{0x583b,0x28},
	{0x583c,0x42},
	{0x583d,0xce},
	{0x5025,0x00},
	{0x3a0f,0x30},
	{0x3a10,0x28},
	{0x3a1b,0x30},
	{0x3a1e,0x26},
	{0x3a11,0x60},
	{0x3a1f,0x14},
	{0x3008,0x02},
	{I2C_FLAG, I2C_FLAG}
};
#elif defined(OV5640_720P_30FPS)
static struct reg_fmt sensor_initialize[] = {
	/* 1280x720p HD 30fps
	 */
	{0x3008, 0x82},
	{0x3103, 0x03},
	{0x3017, 0xff},
	{0x3018, 0xff},
	{0x3108, 0x01},
	{0x3037, 0x13},
	{0x3630, 0x2e},
	{0x3632, 0xe2},
	{0x3633, 0x23},
	{0x3634, 0x44},
	{0x3621, 0xe0},
	{0x3704, 0xa0},
	{0x3703, 0x5a},
	{0x3715, 0x78},
	{0x3717, 0x01},
	{0x370b, 0x60},
	{0x3705, 0x1a},
	{0x3905, 0x02},
	{0x3906, 0x10},
	{0x3901, 0x0a},
	{0x3731, 0x12},
	{0x3600, 0x08},
	{0x3601, 0x33},
	{0x471c, 0x50},
	{0x3820, 0x41},
	{0x3821, 0x27},
	{0x3814, 0x31},
	{0x3815, 0x31},
	{0x3800, 0x00},
	{0x3801, 0x00},
	{0x3802, 0x00},
	{0x3803, 0xfa},
	{0x3804, 0x0a},
	{0x3805, 0x3f},
	{0x3806, 0x06},
	{0x3807, 0xa9},
	{0x3808, 0x05},
	{0x3809, 0x00},
	{0x380a, 0x02},
	{0x380b, 0xd0},
	{0x380c, 0x07},
	{0x380d, 0x64},
	{0x380e, 0x02},
	{0x380f, 0xe4},
	{0x3810, 0x00},
	{0x3811, 0x10},
	{0x3812, 0x00},
	{0x3813, 0x04},
	{0x3618, 0x00},
	{0x3612, 0x49},
	{0x3708, 0x62},
	{0x3709, 0x52},
	{0x370c, 0x03},
	{0x3a02, 0x02},
	{0x3a03, 0xe4},
	{0x3a08, 0x01},
	{0x3a09, 0xbc},
	{0x3a0a, 0x01},
	{0x3a0b, 0x72},
	{0x3a0e, 0x01},
	{0x3a0d, 0x02},
	{0x3a14, 0x02},
	{0x3a15, 0xe4},
	{0x4001, 0x02},
	{0x4004, 0x02},
	{0x3002, 0x00},
	{0x3006, 0xff},
	{0x4300, 0x30},
	{0x501f, 0x00},
	{0x4713, 0x03},
	{0x3035, 0x11},
	{0x4407, 0x04},
	{0x460b, 0x35},
	{0x460c, 0x22},
	{0x3824, 0x04},
	{0x5000, 0xa7},
	{0x5001, 0x83},
	{0x5000, 0xa7},
	{0x3622, 0x01},
	{0x3635, 0x1c},
	{0x3634, 0x40},
	{0x3c01, 0x34},
	{0x3c00, 0x00},
	{0x3c04, 0x28},
	{0x3c05, 0x98},
	{0x3c06, 0x00},
	{0x3c07, 0x08},
	{0x3c08, 0x00},
	{0x3c09, 0x1c},
	{0x300c, 0x22},
	{0x3c0a, 0x9c},
	{0x3c0b, 0x40},
	{0x5180, 0xff},
	{0x5181, 0xf2},
	{0x5182, 0x00},
	{0x5183, 0x94},
	{0x5184, 0x25},
	{0x5185, 0x24},
	{0x5186, 0x06},
	{0x5187, 0x08},
	{0x5188, 0x08},
	{0x5189, 0x78},
	{0x518a, 0x54},
	{0x518b, 0xb2},
	{0x518c, 0xb2},
	{0x518d, 0x44},
	{0x518e, 0x3d},
	{0x518f, 0x58},
	{0x5190, 0x46},
	{0x5191, 0xf8},
	{0x5192, 0x04},
	{0x5193, 0x70},
	{0x5194, 0xf0},
	{0x5195, 0xf0},
	{0x5196, 0x03},
	{0x5197, 0x01},
	{0x5198, 0x04},
	{0x5199, 0x12},
	{0x519a, 0x04},
	{0x519b, 0x00},
	{0x519c, 0x06},
	{0x519d, 0x82},
	{0x519e, 0x38},
	{0x5381, 0x1c},
	{0x5382, 0x5a},
	{0x5383, 0x06},
	{0x5384, 0x20},
	{0x5385, 0x80},
	{0x5386, 0xa0},
	{0x5387, 0xa2},
	{0x5388, 0xa0},
	{0x5389, 0x02},
	{0x538a, 0x01},
	{0x538b, 0x98},
	{0x5300, 0x08},
	{0x5301, 0x30},
	{0x5302, 0x10},
	{0x5303, 0x00},
	{0x5304, 0x08},
	{0x5305, 0x30},
	{0x5306, 0x08},
	{0x5307, 0x16},
	{0x5309, 0x08},
	{0x530a, 0x30},
	{0x530b, 0x04},
	{0x530c, 0x06},
	{0x5480, 0x01},
	{0x5481, 0x08},
	{0x5482, 0x14},
	{0x5483, 0x28},
	{0x5484, 0x51},
	{0x5485, 0x65},
	{0x5486, 0x71},
	{0x5487, 0x7d},
	{0x5488, 0x87},
	{0x5489, 0x91},
	{0x548a, 0x9a},
	{0x548b, 0xaa},
	{0x548c, 0xb8},
	{0x548d, 0xcd},
	{0x548e, 0xdd},
	{0x548f, 0xea},
	{0x5490, 0x1d},
	{0x5580, 0x02},
	{0x5583, 0x40},
	{0x5584, 0x10},
	{0x5589, 0x10},
	{0x558a, 0x00},
	{0x558b, 0xf8},
	{0x5800, 0x23},
	{0x5801, 0x15},
	{0x5802, 0x10},
	{0x5803, 0x10},
	{0x5804, 0x15},
	{0x5805, 0x23},
	{0x5806, 0x0c},
	{0x5807, 0x08},
	{0x5808, 0x05},
	{0x5809, 0x05},
	{0x580a, 0x08},
	{0x580b, 0x0c},
	{0x580c, 0x07},
	{0x580d, 0x03},
	{0x580e, 0x00},
	{0x580f, 0x00},
	{0x5810, 0x03},
	{0x5811, 0x07},
	{0x5812, 0x07},
	{0x5813, 0x03},
	{0x5814, 0x00},
	{0x5815, 0x00},
	{0x5816, 0x03},
	{0x5817, 0x07},
	{0x5818, 0x0b},
	{0x5819, 0x08},
	{0x581a, 0x05},
	{0x581b, 0x05},
	{0x581c, 0x07},
	{0x581d, 0x0b},
	{0x581e, 0x2a},
	{0x581f, 0x16},
	{0x5820, 0x11},
	{0x5821, 0x11},
	{0x5822, 0x15},
	{0x5823, 0x29},
	{0x5824, 0xbf},
	{0x5825, 0xaf},
	{0x5826, 0x9f},
	{0x5827, 0xaf},
	{0x5828, 0xdf},
	{0x5829, 0x6f},
	{0x582a, 0x8e},
	{0x582b, 0xab},
	{0x582c, 0x9e},
	{0x582d, 0x7f},
	{0x582e, 0x4f},
	{0x582f, 0x89},
	{0x5830, 0x86},
	{0x5831, 0x98},
	{0x5832, 0x6f},
	{0x5833, 0x4f},
	{0x5834, 0x6e},
	{0x5835, 0x7b},
	{0x5836, 0x7e},
	{0x5837, 0x6f},
	{0x5838, 0xde},
	{0x5839, 0xbf},
	{0x583a, 0x9f},
	{0x583b, 0xbf},
	{0x583c, 0xec},
	{0x5025, 0x00},
	{0x3a0f, 0x30},
	{0x3a10, 0x28},
	{0x3a1b, 0x30},
	{0x3a1e, 0x26},
	{0x3a11, 0x60},
	{0x3a1f, 0x14},
	{0x3a18, 0x00},
	{0x3a19, 0xf8},
	{0x3035, 0x21},
	{I2C_FLAG, I2C_FLAG}
};
#elif defined(OV5640_SVGA_15FPS)
static struct reg_fmt sensor_initialize[] = {
	/* 800x600 SVGA 15fps
	 */
	{0x3103, 0x11},
	{0x3008, 0x82},
	{0x3008, 0x42},
	{0x3103, 0x03},
	{0x3017, 0xff},
	{0x3018, 0xff},
	{0x3034, 0x1a},
	{0x3035, 0x21},
	{0x3036, 0x46},
	{0x3037, 0x13},
	{0x3108, 0x01},
	{0x3630, 0x36},
	{0x3631, 0x0e},
	{0x3632, 0xe2},
	{0x3633, 0x12},
	{0x3621, 0xe0},
	{0x3704, 0xa0},
	{0x3703, 0x5a},
	{0x3715, 0x78},
	{0x3717, 0x01},
	{0x370b, 0x60},
	{0x3705, 0x1a},
	{0x3905, 0x02},
	{0x3906, 0x10},
	{0x3901, 0x0a},
	{0x3731, 0x12},
	{0x3600, 0x08},
	{0x3601, 0x33},
	{0x302d, 0x60},
	{0x3620, 0x52},
	{0x371b, 0x20},
	{0x471c, 0x50},
	{0x3a13, 0x43},
	{0x3a18, 0x00},
	{0x3a19, 0xf8},
	{0x3635, 0x13},
	{0x3636, 0x03},
	{0x3634, 0x40},
	{0x3622, 0x01},
	{0x3c01, 0x34},
	{0x3c04, 0x28},
	{0x3c05, 0x98},
	{0x3c06, 0x00},
	{0x3c07, 0x08},
	{0x3c08, 0x00},
	{0x3c09, 0x1c},
	{0x3c0a, 0x9c},
	{0x3c0b, 0x40},
	{0x3820, 0x41},
	{0x3821, 0x07},
	{0x3814, 0x31},
	{0x3815, 0x31},
	{0x3800, 0x00},
	{0x3801, 0x00},
	{0x3802, 0x00},
	{0x3803, 0x04},
	{0x3804, 0x0a},
	{0x3805, 0x3f},
	{0x3806, 0x07},
	{0x3807, 0x9b},
	{0x3808, 0x03},
	{0x3809, 0x20},
	{0x380a, 0x02},
	{0x380b, 0x58},
	{0x380c, 0x07},
	{0x380d, 0x68},
	{0x380e, 0x03},
	{0x380f, 0xd8},
	{0x3810, 0x00},
	{0x3811, 0x10},
	{0x3812, 0x00},
	{0x3813, 0x06},
	{0x3618, 0x00},
	{0x3612, 0x29},
	{0x3708, 0x64},
	{0x3709, 0x52},
	{0x370c, 0x03},
	{0x3a02, 0x03},
	{0x3a03, 0xd8},
	{0x3a08, 0x01},
	{0x3a09, 0x27},
	{0x3a0a, 0x00},
	{0x3a0b, 0xf6},
	{0x3a0e, 0x03},
	{0x3a0d, 0x04},
	{0x3a14, 0x03},
	{0x3a15, 0xd8},
	{0x4001, 0x02},
	{0x4004, 0x02},
	{0x3000, 0x00},
	{0x3002, 0x1c},
	{0x3004, 0xff},
	{0x3006, 0xc3},
	{0x300e, 0x58},
	{0x302e, 0x00},
	{0x4740, 0x20},
	{0x4300, 0x30},
	{0x501f, 0x00},
	{0x4713, 0x03},
	{0x4407, 0x04},
	{0x440e, 0x00},
	{0x460b, 0x35},
	{0x460c, 0x20},
	{0x4837, 0x22},
	{0x3824, 0x02},
	{0x5000, 0xa7},
	{0x5001, 0xa3},
	{0x5180, 0xff},
	{0x5181, 0xf2},
	{0x5182, 0x00},
	{0x5183, 0x14},
	{0x5184, 0x25},
	{0x5185, 0x24},
	{0x5186, 0x09},
	{0x5187, 0x09},
	{0x5188, 0x09},
	{0x5189, 0x75},
	{0x518a, 0x54},
	{0x518b, 0xe0},
	{0x518c, 0xb2},
	{0x518d, 0x42},
	{0x518e, 0x3d},
	{0x518f, 0x56},
	{0x5190, 0x46},
	{0x5191, 0xf8},
	{0x5192, 0x04},
	{0x5193, 0x70},
	{0x5194, 0xf0},
	{0x5195, 0xf0},
	{0x5196, 0x03},
	{0x5197, 0x01},
	{0x5198, 0x04},
	{0x5199, 0x12},
	{0x519a, 0x04},
	{0x519b, 0x00},
	{0x519c, 0x06},
	{0x519d, 0x82},
	{0x519e, 0x38},
	{0x5381, 0x1e},
	{0x5382, 0x5b},
	{0x5383, 0x08},
	{0x5384, 0x0a},
	{0x5385, 0x7e},
	{0x5386, 0x88},
	{0x5387, 0x7c},
	{0x5388, 0x6c},
	{0x5389, 0x10},
	{0x538a, 0x01},
	{0x538b, 0x98},
	{0x5300, 0x08},
	{0x5301, 0x30},
	{0x5302, 0x10},
	{0x5303, 0x00},
	{0x5304, 0x08},
	{0x5305, 0x30},
	{0x5306, 0x08},
	{0x5307, 0x16},
	{0x5309, 0x08},
	{0x530a, 0x30},
	{0x530b, 0x04},
	{0x530c, 0x06},
	{0x5480, 0x01},
	{0x5481, 0x08},
	{0x5482, 0x14},
	{0x5483, 0x28},
	{0x5484, 0x51},
	{0x5485, 0x65},
	{0x5486, 0x71},
	{0x5487, 0x7d},
	{0x5488, 0x87},
	{0x5489, 0x91},
	{0x548a, 0x9a},
	{0x548b, 0xaa},
	{0x548c, 0xb8},
	{0x548d, 0xcd},
	{0x548e, 0xdd},
	{0x548f, 0xea},
	{0x5490, 0x1d},
	{0x5580, 0x02},
	{0x5583, 0x40},
	{0x5584, 0x10},
	{0x5589, 0x10},
	{0x558a, 0x00},
	{0x558b, 0xf8},
	{0x5800, 0x23},
	{0x5801, 0x14},
	{0x5802, 0x0f},
	{0x5803, 0x0f},
	{0x5804, 0x12},
	{0x5805, 0x26},
	{0x5806, 0x0c},
	{0x5807, 0x08},
	{0x5808, 0x05},
	{0x5809, 0x05},
	{0x580a, 0x08},
	{0x580b, 0x0d},
	{0x580c, 0x08},
	{0x580d, 0x03},
	{0x580e, 0x00},
	{0x580f, 0x00},
	{0x5810, 0x03},
	{0x5811, 0x09},
	{0x5812, 0x07},
	{0x5813, 0x03},
	{0x5814, 0x00},
	{0x5815, 0x01},
	{0x5816, 0x03},
	{0x5817, 0x08},
	{0x5818, 0x0d},
	{0x5819, 0x08},
	{0x581a, 0x05},
	{0x581b, 0x06},
	{0x581c, 0x08},
	{0x581d, 0x0e},
	{0x581e, 0x29},
	{0x581f, 0x17},
	{0x5820, 0x11},
	{0x5821, 0x11},
	{0x5822, 0x15},
	{0x5823, 0x28},
	{0x5824, 0x46},
	{0x5825, 0x26},
	{0x5826, 0x08},
	{0x5827, 0x26},
	{0x5828, 0x64},
	{0x5829, 0x26},
	{0x582a, 0x24},
	{0x582b, 0x22},
	{0x582c, 0x24},
	{0x582d, 0x24},
	{0x582e, 0x06},
	{0x582f, 0x22},
	{0x5830, 0x40},
	{0x5831, 0x42},
	{0x5832, 0x24},
	{0x5833, 0x26},
	{0x5834, 0x24},
	{0x5835, 0x22},
	{0x5836, 0x22},
	{0x5837, 0x26},
	{0x5838, 0x44},
	{0x5839, 0x24},
	{0x583a, 0x26},
	{0x583b, 0x28},
	{0x583c, 0x42},
	{0x583d, 0xce},
	{0x5025, 0x00},
	{0x3a0f, 0x30},
	{0x3a10, 0x28},
	{0x3a1b, 0x30},
	{0x3a1e, 0x26},
	{0x3a11, 0x60},
	{0x3a1f, 0x14},
	{0x3008, 0x02},
	{I2C_FLAG, I2C_FLAG}
};
#endif

static struct reg_fmt sensor_set_preview[] = {
	{I2C_FLAG, I2C_FLAG}
};

static struct reg_fmt *sensor_reg_common[2] = {
	sensor_initialize,
	sensor_set_preview
};

static void read_regs(struct i2c_client *client, const struct reg_fmt reglist[])
{
	unsigned char val;
	const struct reg_fmt *next = reglist;

	printk("---read sensor regs---\n");
	while (!(next->reg == I2C_FLAG && next->val == I2C_FLAG)) {
		if (next->reg == I2C_FLAG && next->val != I2C_FLAG) {
			next++;
		} else {
			if (cif_i2c_recv(client, next->reg, 2, &val, 1))
				printk("error: i2c_recv{0x%04x}\n", next->reg);
			printk("0x%04x: 0x%02x = 0x%02x", next->reg, next->val, val);
			if (next->val != val) printk("\e[31m mismatch! \e[0m\n");
			else  printk("\n");
			next++;
		}
	}
	printk("----------------------\n");
}

static int write_regs(struct i2c_client *client, const struct reg_fmt reglist[])
{
	int err, err_cnt = 0;
	unsigned char data[3];
	const struct reg_fmt *next = reglist;

	dprintk("ov5640 sensor init\n");

	while (!(next->reg == I2C_FLAG && next->val == I2C_FLAG)) {
		if (next->reg == I2C_FLAG && next->val != I2C_FLAG) {
			mdelay(next->val);
			dprintk("sensor write mdelay(%d)\n", next->val);
			next++;
		} else {
again_reg:
			data[0] = next->reg >> 8;
			data[1] = (u8)next->reg & 0xff;
			data[2] = next->val;
			err = cif_i2c_send(client, data, 2, 1);
			if (err) {
				printk("error: i2c_send{0x%02x%02x, 0x%02x} try(%d)\n", data[0], data[1], data[2], err_cnt);
				if (err_cnt++ >= 3) return err;
				else goto again_reg;
			}
#ifdef DBG_I2C_READ
			{
				unsigned char val;
				err = cif_i2c_recv(client, next->reg, 2, &val, 1);
				if (err) dprintk("error: i2c_recv{0x%04x, 0x%02x}\n", next->reg, val);
				dprintk("0x%04x: 0x%02x = 0x%02x", next->reg, data[2], val);

				if (data[2] != val) {
					printk("\e[31m mismatch! \e[0m\n");
					cif_i2c_send(client, data, 2, 1);
					cif_i2c_recv(client, next->reg, 2, &val, 1);
					dprintk("       retry = 0x%02x\n", val);
				} else {
					dprintk("\n");
				}
			}
#endif
			err_cnt = 0;
			next++;
		}
	}

	return 0;
}

static int sensor_open(struct tcc_video_device *vdev)
{
	int ret;
	unsigned char pid[2];

	cif_power_disable(vdev);
	msleep(10);

	cif_power_enable(vdev);
	msleep(10);

	cif_powerdown_disable(vdev);
	msleep(10);

	cif_reset_low(vdev);
	msleep(10);

	cif_open(vdev);
	msleep(50);

	cif_reset_high(vdev);
	msleep(10);

	/* check ID */
	cif_i2c_recv(vdev->cif_i2c_client, 0x300a, 2, &pid[0], 1);
	cif_i2c_recv(vdev->cif_i2c_client, 0x300b, 2, &pid[1], 1);
	if ((pid[0] != 0x56) || (pid[1] != 0x40)) {
		printk("\e[31m error: ov5640 pid is mismatch(0x%x%x) \e[0m \n", pid[0], pid[1]);
		return -EIO;
	}
	dprintk("\e[31m ov%x%x \e[0m \n", pid[0], pid[1]);

	ret = write_regs(vdev->cif_i2c_client, sensor_reg_common[0]);

	if (0) read_regs(vdev->cif_i2c_client, sensor_reg_common[0]);

	return ret;
}

static int sensor_close(struct tcc_video_device *vdev)
{
	cif_reset_low(vdev);
	cif_power_disable(vdev);
	cif_powerdown_enable(vdev);

	cif_close(vdev);
	msleep(5);

	return 0;
}

static int sensor_powerdown(struct tcc_video_device *vdev)
{
	cif_reset_low(vdev);
	cif_power_disable(vdev);
	cif_powerdown_enable(vdev);
	return 0;
}

static int sensor_preview(struct tcc_video_device *vdev)
{
	return write_regs(vdev->cif_i2c_client, sensor_reg_common[1]);
}

static int sensor_v4l2_set_ctrl(struct tcc_video_device *vdev, __u32 id, int val)
{
	int ret = -EINVAL;

	switch (id) {
	case V4L2_CID_FRAMESKIP:
		ret = vincore_set_frameskip(vdev, val);
		break;
	default:
		break;
	}
	return ret;
}

void sensor_init_ov5640(struct sensor_info *sinfo)
{
	int i, v4l2_ctrl_size;

	/* basic info */
	sinfo->name				= "ov5640";
	sinfo->i2c_addr			= (0x78 >> 1);	/* 7bit addr: 0x3c */
	sinfo->sensor_sizes		= sensor_sizes;
	sinfo->input_data_fmt	= FMT_YUV422_8BIT;
	sinfo->input_data_order	= ORDER_RGB;
	sinfo->vin_y2r_mode		= VIN_Y2R_NOT_USE;
	sinfo->wdma_r2y_mode	= WDMA_R2Y_NOT_USE;
#if defined(OV5640_1080P_30FPS)
	sinfo->prv_w			= 1920;
	sinfo->prv_h			= 1080;
	sinfo->framerate		= 30;
	sinfo->mclk				= 240000;
	sinfo->polarity_pclk 	= POSITIVE_EDGE;
#elif defined(OV5640_1080P_24FPS)
	sinfo->prv_w			= 1920;
	sinfo->prv_h			= 1080;
	sinfo->framerate		= 30;
	sinfo->mclk				= 240000;
	sinfo->polarity_pclk 	= POSITIVE_EDGE;
#elif defined(OV5640_1080P_15FPS)
	sinfo->prv_w			= 1920;
	sinfo->prv_h			= 1080;
	sinfo->framerate		= 30;
	sinfo->mclk				= 240000;
	sinfo->polarity_pclk 	= POSITIVE_EDGE;
#elif defined(OV5640_720P_30FPS)
	sinfo->prv_w			= 1280;
	sinfo->prv_h			= 720;
	sinfo->framerate		= 60;
	sinfo->mclk				= 240000;
	sinfo->polarity_pclk 	= POSITIVE_EDGE;
#elif defined(OV5640_SVGA_15FPS)
	sinfo->prv_w			= 800;
	sinfo->prv_h			= 600;
	sinfo->framerate		= 15;
	sinfo->mclk				= 240000;
	sinfo->polarity_pclk 	= POSITIVE_EDGE;
#endif
	sinfo->polarity_vsync	= ACT_LOW;
	sinfo->polarity_hsync	= ACT_HIGH;
	sinfo->de2hsync			= DE_FROM_HS_CONNECT;
	sinfo->interface_type	= BT601;
	sinfo->scan_type		= SCAN_PROGRESSIVE;
	sinfo->frame_skip_vin	= FRAME_NOT_SKIP;
	sinfo->frame_skip_irq	= FRAME_NOT_SKIP;

	if (sinfo->frame_skip_vin == FRAME_SKIP || sinfo->frame_skip_irq == FRAME_SKIP)
		sinfo->framerate	= sinfo->framerate / 2;

	/* zoom */
	sinfo->zoom_type		= ZOOM_NOT_USE;
	sinfo->prv_zoffx		= 0;
	sinfo->prv_zoffy		= 0;

	/* callback func */
	sinfo->open				= sensor_open;
	sinfo->close			= sensor_close;
	sinfo->powerdown		= sensor_powerdown;
	sinfo->set_preview		= sensor_preview;

	/* sensor tunning func */
	sinfo->v4l2_set_ctrl	= sensor_v4l2_set_ctrl;
	sinfo->need_new_set		= 0;
	sinfo->v4l2_re_ctrl		= _v4l2_re_ctrl;
	sinfo->n_v4l2_re_ctrl	= ARRAY_SIZE(_v4l2_re_ctrl);
	sinfo->n_v4l2_ctrl		= ARRAY_SIZE(_v4l2_ctrl);
	v4l2_ctrl_size = (sizeof(struct v4l2_ctrl_t) * sinfo->n_v4l2_ctrl);
	sinfo->v4l2_ctrl = kzalloc(v4l2_ctrl_size, GFP_KERNEL);
	memcpy(sinfo->v4l2_ctrl, _v4l2_ctrl, v4l2_ctrl_size);

	/* initialize current_value */
	for (i = 0; i < sinfo->n_v4l2_ctrl; i++) {
		sinfo->v4l2_ctrl[i].current_value = sinfo->v4l2_ctrl[i].qc.default_value;
		if (sinfo->v4l2_ctrl[i].qc.id == V4L2_CID_ZOOM_ABSOLUTE
			&& sinfo->zoom_type == ZOOM_USE_SW) {
				sinfo->v4l2_ctrl[i].qc.maximum = ZOOM_USE_SW_MAX_VAL;
				sinfo->v4l2_ctrl[i].qc.flags = 0;
		}
	}
}
EXPORT_SYMBOL(sensor_init_ov5640);
